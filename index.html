<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WunschWelle - Wunschzettel App</title>
    
    <!-- 1. Tailwind CSS für das Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Babel für React (JSX) Übersetzung im Browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- 3. Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Plus, Trash2, Gift, MessageCircle, CheckCircle, 
            Share2, Lock, EyeOff, Users, Send, Sparkles, 
            LogOut, User, PieChart, Mail, Key, 
            Check, Link as LinkIcon, 
            ChevronRight, Calendar, List, ShoppingBag, Search, ArrowRight, Copy, Hash, 
            Image as ImageIcon, Heart, Lightbulb, ThumbsUp,
            Smartphone, Shirt, Home, BookOpen, Coffee, Music, Smile, Star, Wand2, Loader2, X, RefreshCw, Pencil, Save, ExternalLink
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendEmailVerification
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            doc, 
            updateDoc, 
            deleteDoc, 
            serverTimestamp,
            getDoc,
            arrayUnion
        } from 'firebase/firestore';
        
        // --- FIREBASE KONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHbZj73RUzb9HzXfaaZXU4E03CV14KfYo",
            authDomain: "wunschliste-f6271.firebaseapp.com",
            projectId: "wunschliste-f6271",
            storageBucket: "wunschliste-f6271.firebasestorage.app",
            messagingSenderId: "802607999884",
            appId: "1:802607999884:web:f7cef06a2da60d0ace44a9",
            measurementId: "G-4NHT3SRWES"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'wunschliste-live-app';

        // --- HELPER ---
        const CATEGORIES = [
            { id: 'general', label: 'Allgemein', icon: Star },
            { id: 'tech', label: 'Technik', icon: Smartphone },
            { id: 'home', label: 'Haushalt', icon: Home },
            { id: 'clothing', label: 'Kleidung', icon: Shirt },
            { id: 'books', label: 'Bücher', icon: BookOpen },
            { id: 'hobby', label: 'Hobby', icon: Smile },
            { id: 'food', label: 'Essen & Trinken', icon: Coffee },
        ];

        const getCategoryIcon = (id) => {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.icon : Star;
        };

        const getCategoryLabel = (id) => {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.label : 'Allgemein';
        };

        const safeUpdateURL = (param) => {
            try {
                const url = param ? `?list=${param}` : window.location.pathname;
                window.history.pushState({}, '', url);
            } catch (e) { console.warn("URL Update suppressed:", e); }
        };
        
        const triggerConfetti = () => {
            if (typeof window.confetti === 'function') {
                window.confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444']
                });
            }
        };

        const getPriorityWeight = (p) => {
            if (p === 'high') return 3;
            if (p === 'medium') return 2;
            if (p === 'low') return 1;
            return 2; 
        };

        const sortItems = (a, b) => {
            const weightA = getPriorityWeight(a.priority);
            const weightB = getPriorityWeight(b.priority);
            if (weightA !== weightB) return weightB - weightA; 
            return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
        };
        
        const sortByDateDesc = (a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
        const sortByDateAsc = (a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);

        const parsePrice = (priceStr) => {
            if (!priceStr) return 0;
            const cleanStr = priceStr.replace(/[^0-9,.]/g, '').replace(',', '.');
            const val = parseFloat(cleanStr);
            return isNaN(val) ? 0 : val;
        };

        // --- COMPONENTS ---

        const PriorityBadge = ({ priority }) => {
            if (priority === 'high') return <span className="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1"><Heart size={10} fill="currentColor" /> Herzenswunsch</span>;
            if (priority === 'low') return <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1"><Lightbulb size={10} /> Nur eine Idee</span>;
            return null;
        };

        const ContributionModal = ({ item, currentUserUid, onClose, onConfirm }) => {
            const myContribution = item.contributors?.find(c => c.uid === currentUserUid);
            const [amount, setAmount] = useState(myContribution?.amount || '');
            
            const handleSubmit = () => {
                const val = parseFloat(amount);
                if (isNaN(val) || val < 0) return alert("Bitte einen gültigen Betrag eingeben");
                onConfirm(item, val);
                onClose();
            };

            const targetPrice = parsePrice(item.price);
            const alreadyCollected = (item.contributors || []).reduce((acc, c) => acc + (c.amount || 0), 0) - (myContribution?.amount || 0);
            const missing = Math.max(0, targetPrice - alreadyCollected);

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl w-full max-w-xs p-6 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={20} /></button>
                        <h2 className="text-lg font-bold mb-1">Sammelgeschenk</h2>
                        <p className="text-sm text-slate-500 mb-4">{item.title}</p>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold uppercase text-slate-400 mb-1">Dein Beitrag (€)</label>
                                <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-lg font-bold text-center" placeholder="0.00" autoFocus />
                            </div>
                            {targetPrice > 0 && <div className="text-xs text-center text-slate-500 bg-slate-50 p-2 rounded-lg">Offen: <strong>{missing.toFixed(2)} €</strong></div>}
                            <button onClick={handleSubmit} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200">{myContribution ? 'Aktualisieren' : 'Beteiligen'}</button>
                            {myContribution && <button onClick={() => { onConfirm(item, 0); onClose(); }} className="w-full text-red-500 text-sm hover:underline">Verlassen (Beitrag löschen)</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const WishDetailModal = ({ item, currentMode, onClose, onToggleReservation, onToggleBought, currentUserUid, onOpenContribution }) => {
            const isContributer = item.contributors?.some(c => c.uid === currentUserUid);
            const myContribution = item.contributors?.find(c => c.uid === currentUserUid);
            const contributorCount = item.contributors?.length || 0;
            const isGroupMode = (item.contributors && item.contributors.length > 0) || item.isGroupGift;
            const isReservedByMe = item.reservedBy?.uid === currentUserUid;
            const isReserved = !!item.reservedBy;
            const CategoryIcon = getCategoryIcon(item.category);
            const targetPrice = parsePrice(item.price);
            const totalCollected = (item.contributors || []).reduce((acc, c) => acc + (c.amount || 0), 0);
            const progress = targetPrice > 0 ? Math.min(100, (totalCollected / targetPrice) * 100) : 0;

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[90vh] sm:rounded-2xl rounded-t-3xl shadow-2xl relative overflow-y-auto flex flex-col">
                        <button onClick={onClose} className="absolute top-4 right-4 z-10 bg-black/20 hover:bg-black/40 text-white p-2 rounded-full backdrop-blur-md transition-colors"><X size={20} /></button>
                        {item.image ? (
                            <div className="h-64 w-full shrink-0 relative">
                                <img src={item.image} alt={item.title} className="w-full h-full object-cover" />
                                <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                {item.price && <span className="absolute bottom-4 left-4 bg-white/90 text-slate-800 font-bold px-3 py-1.5 rounded-lg shadow-sm text-lg">{item.price}</span>}
                            </div>
                        ) : (
                            <div className="h-24 bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center shrink-0"><Gift size={48} className="text-white/30" /></div>
                        )}
                        <div className="p-6 flex-1 flex flex-col gap-6">
                            <div>
                                <div className="flex flex-wrap gap-2 mb-3">
                                    <PriorityBadge priority={item.priority} />
                                    <span className="bg-slate-100 text-slate-600 px-2.5 py-1 rounded-md text-xs font-bold uppercase tracking-wider flex items-center gap-1.5"><CategoryIcon size={12} /> {getCategoryLabel(item.category)}</span>
                                </div>
                                <h2 className="text-2xl font-bold text-slate-800 leading-tight">{item.title}</h2>
                                {!item.image && item.price && <p className="text-lg font-medium text-indigo-600 mt-1">{item.price}</p>}
                            </div>
                            {item.link && (
                                <a href={item.link.startsWith('http') ? item.link : `https://${item.link}`} target="_blank" rel="noopener noreferrer" className="flex items-center justify-between p-4 bg-indigo-50 border border-indigo-100 rounded-xl hover:bg-indigo-100 transition-colors group">
                                    <span className="font-semibold text-indigo-700 flex items-center gap-2"><ShoppingBag size={18} /> Zum Shop</span>
                                    <ExternalLink size={18} className="text-indigo-400 group-hover:text-indigo-600" />
                                </a>
                            )}
                            {isGroupMode && targetPrice > 0 && (
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    <div className="flex justify-between text-sm mb-2"><span className="font-bold text-slate-700">{totalCollected.toFixed(2)}€ gesammelt</span><span className="text-slate-400">Ziel: {targetPrice.toFixed(2)}€</span></div>
                                    <div className="h-3 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-blue-500 transition-all duration-1000" style={{ width: `${progress}%` }}></div></div>
                                </div>
                            )}
                            {currentMode === 'guest' && (
                                <div className="mt-auto border-t border-slate-100 pt-6">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">Aktionen</h3>
                                    {isGroupMode ? (
                                        <div className="space-y-3">
                                            <div className="text-sm text-blue-700 bg-blue-50 p-3 rounded-lg">
                                                <div className="flex items-center gap-2 font-bold mb-1"><Users size={16} /> {contributorCount} Beteiligte:</div>
                                                <div className="flex flex-wrap gap-1">{(item.contributors || []).map((c, i) => <span key={i} className="bg-white/50 px-1.5 py-0.5 rounded text-xs border border-blue-100">{c.name} {c.amount > 0 && `(${c.amount}€)`}</span>)}</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => onOpenContribution(item)} className={`flex-1 py-3 rounded-xl font-bold text-center transition-all ${isContributer ? 'bg-blue-100 text-blue-700 border border-blue-200' : 'bg-blue-600 text-white shadow-lg shadow-blue-200'}`}>{isContributer ? `Mein Beitrag: ${myContribution?.amount}€ (Ändern)` : 'Beteiligen'}</button>
                                                {isContributer && <button onClick={() => onToggleBought(item)} className={`px-4 py-3 rounded-xl font-bold border transition-colors ${item.isBought ? 'bg-emerald-100 border-emerald-200 text-emerald-700' : 'border-slate-200 text-slate-500'}`}>{item.isBought ? 'Gekauft!' : 'Kaufen?'}</button>}
                                            </div>
                                        </div>
                                    ) : isReserved ? (
                                        <div className="bg-slate-50 p-4 rounded-xl text-center border border-slate-100">
                                            <div className="flex justify-center mb-2"><div className={`w-10 h-10 rounded-full flex items-center justify-center ${item.isBought ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'}`}>{item.isBought ? <Check size={20} /> : <Lock size={20} />}</div></div>
                                            <p className="text-slate-600 text-sm mb-3">{item.isBought ? 'Bereits gekauft von' : 'Reserviert von'} <strong className="text-slate-900">{isReservedByMe ? 'Dir' : item.reservedBy.name}</strong></p>
                                            {isReservedByMe && (
                                                <div className="flex gap-2">
                                                    <button onClick={() => onToggleBought(item)} className={`flex-1 py-2 rounded-lg text-sm font-bold border ${item.isBought ? 'bg-white border-emerald-200 text-emerald-600' : 'bg-emerald-600 text-white border-transparent'}`}>{item.isBought ? 'Doch nicht gekauft?' : 'Als gekauft markieren'}</button>
                                                    <button onClick={() => onToggleReservation(item, 'single')} className="px-4 py-2 rounded-lg text-sm font-bold bg-white border border-slate-200 text-slate-500">Freigeben</button>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => onToggleReservation(item, 'single')} className="bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition-colors flex flex-col items-center justify-center gap-1"><CheckCircle size={20} /><span>Reservieren</span></button>
                                            <button onClick={() => onOpenContribution(item)} className="bg-white border border-blue-200 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-50 transition-colors flex flex-col items-center justify-center gap-1"><PieChart size={20} /><span>Sammeln</span></button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const WishListItem = ({ item, currentMode, currentUserUid, guestName, onDelete, onEdit, onSelect, onToggleReservation, onToggleBought, onOpenContribution }) => {
            const isContributer = item.contributors?.some(c => c.uid === currentUserUid);
            const contributorCount = item.contributors?.length || 0;
            const isGroupMode = (item.contributors && item.contributors.length > 0) || item.isGroupGift;
            const isReservedByMe = item.reservedBy?.uid === currentUserUid;
            const isReserved = !!item.reservedBy;
            const isFullyReserved = isReserved && !isGroupMode;
            const CategoryIcon = getCategoryIcon(item.category);
            const isMySecretGift = currentMode === 'guest' && item.isSecret && (item.addedByUid === currentUserUid);
            const canManage = currentMode === 'owner' || isMySecretGift;
            const targetPrice = parsePrice(item.price);
            const totalCollected = (item.contributors || []).reduce((acc, c) => acc + (c.amount || 0), 0);
            const progress = targetPrice > 0 ? Math.min(100, (totalCollected / targetPrice) * 100) : 0;

            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            const [isSwiped, setIsSwiped] = useState(false);
            const minSwipeDistance = 50;

            const onTouchStart = (e) => { setTouchEnd(null); setTouchStart(e.targetTouches[0].clientX); }
            const onTouchMove = (e) => setTouchEnd(e.targetTouches[0].clientX);
            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                if (isLeftSwipe && canManage) setIsSwiped(true);
                if (isRightSwipe) setIsSwiped(false);
            }
            const handleDeleteSwipe = (e) => { e.stopPropagation(); if(window.confirm("Wirklich löschen?")) onDelete(item.id); else setIsSwiped(false); }

            return (
                <div className="relative overflow-hidden rounded-xl mb-3 group" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                    <div className={`absolute inset-0 bg-red-500 flex items-center justify-end px-6 transition-all duration-300 ${isSwiped ? 'opacity-100' : 'opacity-0'}`} onClick={handleDeleteSwipe}><span className="text-white font-bold flex items-center gap-2">Löschen <Trash2 size={20} /></span></div>
                    <div onClick={() => onSelect(item)} className={`bg-white border rounded-xl overflow-hidden transition-transform duration-300 shadow-sm relative z-10 cursor-pointer active:scale-[0.98] ${isSwiped ? '-translate-x-24' : 'translate-x-0'} ${item.isSecret ? 'border-amber-200 bg-amber-50/50' : item.isBought ? 'border-emerald-200 bg-emerald-50/40' : isGroupMode ? 'border-blue-200 bg-blue-50/30' : 'border-slate-100'}`}>
                        {item.image && (
                            <div className="h-32 w-full overflow-hidden relative group">
                                <img src={item.image} alt={item.title} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" onError={(e) => e.target.style.display = 'none'} />
                                <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-60"></div>
                                {item.price && <span className="absolute bottom-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded-md backdrop-blur-sm">{item.price}</span>}
                            </div>
                        )}
                        <div className="p-4">
                            <div className="flex justify-between items-start mb-2">
                                <div className="flex-1">
                                    <div className="flex flex-wrap gap-2 mb-1">
                                        <PriorityBadge priority={item.priority} />
                                        <span className="bg-slate-100 text-slate-500 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1"><CategoryIcon size={10} /> {getCategoryLabel(item.category)}</span>
                                        {item.isSecret && <span className="text-[10px] font-bold text-amber-600 uppercase tracking-wider flex items-center gap-1 bg-amber-100 px-1.5 py-0.5 rounded"><Sparkles size={10} /> Überraschung</span>}
                                        {isGroupMode && <span className="text-[10px] font-bold text-blue-600 uppercase tracking-wider flex items-center gap-1 bg-blue-100 px-1.5 py-0.5 rounded"><PieChart size={10} /> Sammelgeschenk</span>}
                                        {item.isBought && <span className="text-[10px] font-bold text-emerald-700 uppercase tracking-wider flex items-center gap-1 bg-emerald-100 px-1.5 py-0.5 rounded"><ShoppingBag size={10} /> Bereits Gekauft</span>}
                                    </div>
                                    <h3 className={`font-semibold text-lg ${item.isBought || (isFullyReserved && currentMode === 'guest' && !isReservedByMe) ? 'line-through text-slate-400' : 'text-slate-800'}`}>{item.title}</h3>
                                    <div className="text-sm text-slate-500 mt-1 flex gap-3 flex-wrap">{!item.image && item.price && <span>{item.price}</span>}</div>
                                </div>
                                {canManage && (
                                    <div className="flex gap-1" onClick={(e) => e.stopPropagation()}>
                                        <button onClick={() => onEdit(item)} className="text-slate-300 hover:text-indigo-500 p-2 hover:bg-slate-50 rounded-lg transition-colors" title="Bearbeiten"><Pencil size={16} /></button>
                                        <button onClick={() => onDelete(item.id)} className="text-slate-300 hover:text-red-500 p-2 hover:bg-slate-50 rounded-lg transition-colors" title="Löschen"><Trash2 size={16} /></button>
                                    </div>
                                )}
                            </div>
                            {currentMode === 'guest' && (
                                <div className="mt-3 pt-3 border-t border-slate-100 flex flex-col gap-2">
                                {isGroupMode ? (
                                    <div className="flex flex-col gap-1">
                                        <div className="flex items-center justify-between text-xs text-blue-600"><span className="flex items-center gap-1 font-bold"><Users size={12} /> {contributorCount} machen mit</span>{targetPrice > 0 && <span>{Math.round(progress)}% gesammelt</span>}</div>
                                        {targetPrice > 0 && <div className="h-1.5 bg-slate-100 rounded-full overflow-hidden w-full"><div className="h-full bg-blue-500" style={{ width: `${progress}%` }}></div></div>}
                                    </div>
                                ) : isReserved ? (
                                    <div className="flex items-center gap-2 text-sm text-slate-500"><span className={`w-2 h-2 rounded-full ${item.isBought ? 'bg-emerald-500' : 'bg-slate-400'}`}></span>{item.isBought ? 'Gekauft' : 'Reserviert'} von {isReservedByMe ? 'Dir' : item.reservedBy.name}</div>
                                ) : (
                                    <div className="text-xs text-emerald-600 font-medium flex items-center gap-1"><CheckCircle size={12}/> Verfügbar</div>
                                )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const EditItemModal = ({ item, onClose, onSave }) => {
            const [title, setTitle] = useState(item.title);
            const [price, setPrice] = useState(item.price || '');
            const [link, setLink] = useState(item.link || '');
            const [image, setImage] = useState(item.image || '');
            const [priority, setPriority] = useState(item.priority || 'medium');
            const [category, setCategory] = useState(item.category || 'general');
            const handleSave = () => { onSave(item.id, { title, price, link, image, priority, category }); onClose(); };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={20} /></button>
                        <h2 className="text-xl font-bold mb-4">Wunsch bearbeiten</h2>
                        <div className="space-y-4">
                            <div><label className="block text-xs font-bold uppercase text-slate-400 mb-1">Titel</label><input value={title} onChange={e => setTitle(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                            <div className="flex gap-2">
                                <div className="w-1/3"><label className="block text-xs font-bold uppercase text-slate-400 mb-1">Preis</label><input value={price} onChange={e => setPrice(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                                <div className="flex-1"><label className="block text-xs font-bold uppercase text-slate-400 mb-1">Kategorie</label><select value={category} onChange={e => setCategory(e.target.value)} className="w-full px-3 py-2 border rounded-lg bg-white">{CATEGORIES.map(cat => <option key={cat.id} value={cat.id}>{cat.label}</option>)}</select></div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold uppercase text-slate-400 mb-1">Priorität</label>
                                <div className="flex bg-slate-50 rounded-lg p-1 border border-slate-200">
                                    <button onClick={() => setPriority('high')} className={`flex-1 py-1.5 rounded-md text-xs font-bold flex items-center justify-center gap-1 ${priority === 'high' ? 'bg-white shadow text-red-500' : 'text-slate-400'}`}>Hoch</button>
                                    <button onClick={() => setPriority('medium')} className={`flex-1 py-1.5 rounded-md text-xs font-bold flex items-center justify-center gap-1 ${priority === 'medium' ? 'bg-white shadow text-indigo-500' : 'text-slate-400'}`}>Mittel</button>
                                    <button onClick={() => setPriority('low')} className={`flex-1 py-1.5 rounded-md text-xs font-bold flex items-center justify-center gap-1 ${priority === 'low' ? 'bg-white shadow text-yellow-500' : 'text-slate-400'}`}>Tief</button>
                                </div>
                            </div>
                            <div><label className="block text-xs font-bold uppercase text-slate-400 mb-1">Link</label><input value={link} onChange={e => setLink(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                            <div><label className="block text-xs font-bold uppercase text-slate-400 mb-1">Bild-URL</label><div className="flex gap-2"><input value={image} onChange={e => setImage(e.target.value)} className="flex-1 px-3 py-2 border rounded-lg" />{image && <img src={image} className="w-10 h-10 rounded object-cover border" />}</div></div>
                            <button onClick={handleSave} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 flex items-center justify-center gap-2"><Save size={18} /> Speichern</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ChatArea = ({ messages, guestName, onSend, currentUserUid }) => {
            const [newMessage, setNewMessage] = useState('');
            const handleSend = () => { if (!newMessage.trim()) return; onSend(newMessage); setNewMessage(''); };
            return (
                <div className="flex flex-col h-full pt-2">
                <div className="bg-amber-50 border border-amber-100 p-3 rounded-lg mb-4 text-xs text-amber-800 flex gap-2"><EyeOff size={16} className="shrink-0" /><div><strong>Pssst!</strong> Ersteller sieht das nicht.</div></div>
                <div className="flex-1 space-y-3 mb-4 overflow-y-auto max-h-[50vh] custom-scrollbar">
                    {messages.length === 0 && <div className="text-center text-slate-400 text-sm mt-8">Keine Nachrichten.</div>}
                    {messages.map(msg => { const isMe = msg.uid === currentUserUid || msg.sender === guestName; return ( <div key={msg.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}><div className={`max-w-[85%] rounded-2xl px-4 py-2 text-sm shadow-sm ${isMe ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}`}>{msg.text}</div><span className="text-[10px] text-slate-400 mt-1 px-1">{msg.sender}</span></div> ); })}
                </div>
                <div className="sticky bottom-0 bg-white p-2 border-t flex gap-2"><input value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder="Nachricht..." className="flex-1 px-4 py-2 bg-slate-100 rounded-full focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm" onKeyDown={(e) => e.key === 'Enter' && handleSend()} /><button onClick={handleSend} className="p-2 bg-emerald-600 text-white rounded-full hover:bg-emerald-700"><Send size={18} /></button></div>
                </div>
            );
        };

        const AddItemInput = ({ currentMode, onAdd }) => {
            const [text, setText] = useState('');
            const [price, setPrice] = useState('');
            const [link, setLink] = useState('');
            const [image, setImage] = useState('');
            const [priority, setPriority] = useState('medium'); 
            const [category, setCategory] = useState('general');
            const [fetchingImage, setFetchingImage] = useState(false);

            const handleAdd = () => { if(!text && !link) return; onAdd({ title: text, price, link, image, priority, category, isSecret: currentMode === 'guest' }); setText(''); setPrice(''); setLink(''); setImage(''); setPriority('medium'); setCategory('general'); }
            const fetchMetadata = async (urlToFetch) => {
                let url = urlToFetch || link;
                if (!url) return;
                if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
                setFetchingImage(true);
                try {
                    const encodedUrl = encodeURIComponent(url);
                    const response = await fetch(`https://api.microlink.io/?url=${encodedUrl}&palette=true`);
                    const data = await response.json();
                    if (data.status === 'success') { if (data.data.image && data.data.image.url) setImage(data.data.image.url); }
                } catch (e) { console.error("Meta Fetch Error", e); } finally { setFetchingImage(false); }
            };
            useEffect(() => { const timer = setTimeout(() => { if (link && link.length > 5 && link.includes('.')) fetchMetadata(link); }, 1000); return () => clearTimeout(timer); }, [link]);

            return (
                <div className="sticky bottom-0 bg-white/90 backdrop-blur-md p-4 border-t border-slate-100 shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.1)] z-30">
                <div className="flex flex-col gap-2 max-w-md mx-auto">
                    <div className="flex gap-2 items-center">
                    <input value={text} onChange={(e) => setText(e.target.value)} placeholder={currentMode === 'owner' ? "Neuer Wunsch..." : "Überraschungs-Idee..."} className="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-inner" />
                    <button onClick={handleAdd} disabled={!text} className={`p-3 rounded-xl text-white shadow-lg transform active:scale-95 transition-all ${currentMode === 'owner' ? 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200' : 'bg-amber-500 hover:bg-amber-600 shadow-amber-200'}`}>{currentMode === 'owner' ? <Plus size={24} /> : <Sparkles size={24} />}</button>
                    </div>
                    {currentMode === 'owner' && (
                    <div className="flex flex-col gap-2 animate-in slide-in-from-bottom-2 fade-in duration-300">
                        <div className="flex gap-2 items-center">
                            <input value={price} onChange={(e) => setPrice(e.target.value)} placeholder="Preis" className="w-20 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" />
                            <select value={category} onChange={(e) => setCategory(e.target.value)} className="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm flex-1">{CATEGORIES.map(cat => <option key={cat.id} value={cat.id}>{cat.label}</option>)}</select>
                            <div className="flex bg-slate-50 rounded-lg p-1 border border-slate-200 shrink-0">
                                <button onClick={() => setPriority('high')} className={`p-1.5 rounded-md transition-all ${priority === 'high' ? 'bg-white shadow text-red-500' : 'text-slate-400 hover:text-slate-600'}`} title="Herzenswunsch"><Heart size={16} fill={priority === 'high' ? "currentColor" : "none"} /></button>
                                <button onClick={() => setPriority('medium')} className={`p-1.5 rounded-md transition-all ${priority === 'medium' ? 'bg-white shadow text-indigo-500' : 'text-slate-400 hover:text-slate-600'}`} title="Gerne"><ThumbsUp size={16} /></button>
                                <button onClick={() => setPriority('low')} className={`p-1.5 rounded-md transition-all ${priority === 'low' ? 'bg-white shadow text-yellow-500' : 'text-slate-400 hover:text-slate-600'}`} title="Idee"><Lightbulb size={16} /></button>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                            <div className="relative flex-1"><input value={link} onChange={(e) => setLink(e.target.value)} placeholder="Shop-Link einfügen..." className="w-full pl-3 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" /><button onClick={() => fetchMetadata(link)} disabled={fetchingImage || !link} className="absolute right-1 top-1 p-1.5 bg-indigo-50 text-indigo-400 rounded-md hover:bg-indigo-100 hover:text-indigo-600 disabled:opacity-50 transition-colors" title="Bild manuell suchen">{fetchingImage ? <Loader2 size={14} className="animate-spin" /> : <Wand2 size={14} />}</button></div>
                            {image && <div className="relative w-10 h-10 rounded-lg overflow-hidden border border-slate-200 shadow-sm shrink-0 group"><img src={image} alt="Preview" className="w-full h-full object-cover" /><button onClick={() => setImage('')} className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white"><X size={14} /></button></div>}
                        </div>
                    </div>
                    )}
                </div>
                </div>
            );
        };

        const AuthModal = ({ isOpen, onClose, onLogin, onRegister }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegister, setIsRegister] = useState(false);
            const [error, setError] = useState(null); 
            const [verificationSent, setVerificationSent] = useState(false);
            useEffect(() => { if (isOpen) { setVerificationSent(false); setError(null); } }, [isOpen]);
            if (!isOpen) return null;
            const handleSubmit = async (e) => {
                e.preventDefault(); setError(null);
                try {
                if (isRegister) { const userCredential = await onRegister(email, password); await sendEmailVerification(userCredential.user); await signOut(auth); setVerificationSent(true); } 
                else { const userCredential = await onLogin(email, password); if (!userCredential.user.emailVerified) { await signOut(auth); setError({ msg: "Bitte bestätige erst deine E-Mail-Adresse!", code: 'auth/unverified-email' }); return; } onClose(); }
                } catch (err) { let msg = `Fehler: ${err.message}`; if (err.code === 'auth/invalid-credential') msg = "E-Mail oder Passwort falsch."; setError({ msg, code: err.code }); }
            };
            if (verificationSent) return (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200"><div className="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl text-center"><div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><Mail size={32} /></div><h2 className="text-2xl font-bold mb-2 text-slate-800">Fast geschafft!</h2><p className="text-slate-600 mb-6">Wir haben eine Bestätigungs-E-Mail an <strong>{email}</strong> gesendet. Bitte klicke auf den Link darin.</p><button onClick={() => { setVerificationSent(false); setIsRegister(false); }} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">Zurück zum Login</button></div></div>);
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative">
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">✕</button>
                    <h2 className="text-xl font-bold mb-1">{isRegister ? 'Konto erstellen' : 'Anmelden'}</h2>
                    <p className="text-slate-500 text-sm mb-4">{isRegister ? 'Zum dauerhaften Speichern deiner Listen.' : 'Willkommen zurück!'}</p>
                    {error && <div className="bg-red-50 border border-red-100 text-red-600 text-xs p-3 rounded-lg mb-4 font-bold">{error.msg}</div>}
                    <form onSubmit={handleSubmit} className="space-y-3">
                    <div className="relative"><Mail className="absolute left-3 top-3 text-slate-400" size={16} /><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="E-Mail Adresse" className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required /></div>
                    <div className="relative"><Key className="absolute left-3 top-3 text-slate-400" size={16} /><input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Passwort" className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required minLength={6} /></div>
                    <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">{isRegister ? 'Kostenlos registrieren' : 'Einloggen'}</button>
                    </form>
                    <div className="mt-4 text-center text-sm text-slate-500">{isRegister ? 'Schon ein Konto?' : 'Noch kein Konto?'} <button onClick={() => setIsRegister(!isRegister)} className="ml-1 text-indigo-600 font-semibold hover:underline">{isRegister ? 'Hier einloggen' : 'Jetzt registrieren'} </button></div>
                </div>
                </div>
            );
        };

        function InviteScreen({ listData, onJoin }) {
            const [joinName, setJoinName] = useState('');
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-slate-50">
                <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden animate-in fade-in zoom-in duration-300">
                    <div className="bg-emerald-600 p-8 text-center text-white"><Gift className="w-12 h-12 mx-auto mb-3 text-emerald-100" /><h2 className="text-xl font-medium text-emerald-100 mb-1">Du bist eingeladen zu</h2><h1 className="text-3xl font-bold">{listData.title}</h1><p className="text-sm opacity-80 mt-2">{listData.eventDate && new Date(listData.eventDate).toLocaleDateString('de-DE')}</p></div>
                    <div className="p-8 space-y-4"><p className="text-center text-slate-600 text-sm">Bitte gib deinen Namen ein, um die Wunschliste zu sehen und Geschenke zu reservieren.</p><input type="text" value={joinName} onChange={(e) => setJoinName(e.target.value)} placeholder="Dein Name" className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none text-center text-lg" autoFocus /><button disabled={!joinName} onClick={() => onJoin(listData.id, joinName)} className="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 disabled:opacity-50 transition-all shadow-lg shadow-emerald-200">Liste öffnen &rarr;</button></div>
                </div>
                </div>
            );
        }

        function LandingPage({ onCreate, onJoin, user, onLogin, onRegister, onLogout, myLists, joinedLists, onOpenList, onDeleteList }) { // Updated props
            const [title, setTitle] = useState('');
            const [date, setDate] = useState('');
            const [joinId, setJoinId] = useState('');
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [showJoinInput, setShowJoinInput] = useState(false);

            return (
                <div className="flex flex-col min-h-screen bg-slate-50 relative">
                <AuthModal isOpen={showAuthModal} onClose={() => setShowAuthModal(false)} onLogin={onLogin} onRegister={onRegister} />
                <div className="bg-white/80 backdrop-blur sticky top-0 z-20 border-b border-slate-200 p-4 flex justify-between items-center">
                    <div className="flex items-center gap-2"><div className="bg-indigo-600 p-1.5 rounded-lg text-white"><Gift size={18} /></div><h1 className="font-bold text-slate-800 tracking-tight">WunschWelle</h1></div>
                    {!user || user.isAnonymous ? (<button onClick={() => setShowAuthModal(true)} className="text-sm font-medium text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-lg transition-colors">Anmelden</button>) : (<div className="flex items-center gap-2"><span className="text-xs text-slate-500 hidden sm:inline">{user.email}</span><button onClick={onLogout} className="p-2 text-slate-400 hover:bg-slate-100 rounded-full"><LogOut size={16} /></button></div>)}
                </div>

                <div className="flex-1 p-4 max-w-md mx-auto w-full flex flex-col">
                    {/* SECTION 1: CREATE NEW */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                    <div className="bg-indigo-600 p-6 text-white text-center"><h2 className="text-2xl font-bold mb-2">Wünsche erfüllen.</h2><p className="text-indigo-100 text-sm">Erstelle deine Liste und teile sie mit Freunden.</p></div>
                    <div className="p-6 space-y-4">
                        <div><label className="block text-xs font-bold uppercase text-slate-400 mb-1 tracking-wider">Titel</label><input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="z.B. Mein Geburtstag" className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all bg-slate-50 focus:bg-white" /></div>
                        <div><label className="block text-xs font-bold uppercase text-slate-400 mb-1 tracking-wider">Wann?</label><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full px-4 py-3 rounded-xl border border-slate-200 text-slate-600 focus:ring-2 focus:ring-indigo-500 outline-none transition-all bg-slate-50 focus:bg-white" /></div>
                        <button disabled={!title} onClick={() => onCreate(title, date)} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 disabled:opacity-50 transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2"><Plus size={20} /> Liste starten</button>
                    </div>
                    </div>

                    {/* SECTION 2: MY LISTS */}
                    {user && !user.isAnonymous && (
                    <div className="mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <h3 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2"><List size={16} className="text-indigo-500" /> Deine Listen</h3>
                        {(!myLists || myLists.length === 0) ? (<div className="text-center py-6 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50"><p className="text-slate-400 text-sm mb-1">Noch keine Listen erstellt.</p></div>) : (
                            <div className="space-y-2">{myLists.map(list => (
                                <div key={list.id} onClick={() => onOpenList(list)} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm active:scale-[0.98] transition-all cursor-pointer flex items-center justify-between group">
                                <div><div className="font-bold text-slate-800">{list.title}</div><div className="text-xs text-slate-400 mt-1 flex items-center gap-1"><Calendar size={10} /> {list.eventDate ? new Date(list.eventDate).toLocaleDateString('de-DE') : 'Kein Datum'}</div></div>
                                <div className="flex items-center gap-2"><button onClick={(e) => { e.stopPropagation(); onDeleteList(list.id); }} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={16} /></button><ChevronRight size={20} className="text-slate-300" /></div>
                                </div>
                            ))}</div>
                        )}
                    </div>
                    )}

                    {/* SECTION 3: JOINED LISTS (NEW) */}
                    {user && joinedLists && joinedLists.length > 0 && (
                    <div className="mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <h3 className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2"><Users size={16} className="text-emerald-500" /> Listen von Freunden</h3>
                        <div className="space-y-2">{joinedLists.map(list => (
                            <div key={list.id} onClick={() => onOpenList(list)} className="bg-white p-4 rounded-xl border border-emerald-100 bg-emerald-50/30 shadow-sm active:scale-[0.98] transition-all cursor-pointer flex items-center justify-between group">
                            <div><div className="font-bold text-slate-800">{list.title}</div><div className="text-xs text-slate-400 mt-1 flex items-center gap-1"><Calendar size={10} /> {list.eventDate ? new Date(list.eventDate).toLocaleDateString('de-DE') : 'Kein Datum'}</div></div>
                            <div className="flex items-center gap-2"><span className="text-xs bg-emerald-100 text-emerald-600 px-2 py-1 rounded-full font-bold">Gast</span><ChevronRight size={20} className="text-slate-300" /></div>
                            </div>
                        ))}</div>
                    </div>
                    )}

                    {/* SECTION 4: JOIN MANUALLY */}
                    <div className="mt-auto pt-8 text-center pb-8">
                    {!showJoinInput ? (<button onClick={() => setShowJoinInput(true)} className="text-sm text-slate-400 hover:text-slate-600 flex items-center justify-center gap-1 mx-auto transition-colors"><Search size={14} /> Code eingeben?</button>) : (<div className="flex gap-2 animate-in fade-in slide-in-from-bottom-2"><input type="text" value={joinId} onChange={(e) => setJoinId(e.target.value)} placeholder="Code..." className="flex-1 px-4 py-2 rounded-lg border border-slate-200 text-sm outline-none focus:border-indigo-500 bg-white text-slate-800 shadow-sm" autoFocus /><button disabled={!joinId} onClick={() => onJoin(joinId.trim(), "")} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-900 disabled:opacity-50"><ArrowRight size={16} /></button></div>)}
                    </div>
                </div>
                </div>
            );
        }

        function WishListDashboard({ listData, mode, guestName, onBack, user }) {
            const [items, setItems] = useState([]);
            const [messages, setMessages] = useState([]);
            const [activeTab, setActiveTab] = useState('wishes');
            const [activeCategory, setActiveCategory] = useState('all');
            const [editingItem, setEditingItem] = useState(null);
            const [selectedItem, setSelectedItem] = useState(null); 
            const [contributingItem, setContributingItem] = useState(null);

            useEffect(() => {
                if (!listData?.id) return;
                const itemsRef = collection(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_items`);
                const unsubItems = onSnapshot(itemsRef, (snapshot) => { const loadedItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); loadedItems.sort(sortItems); setItems(loadedItems); }, (error) => console.error("Items Error:", error));
                const chatRef = collection(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_chat`);
                const unsubChat = onSnapshot(chatRef, (snapshot) => { const loadedMsgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); loadedMsgs.sort(sortByDateAsc); setMessages(loadedMsgs); }, (error) => console.error("Chat Error:", error));
                return () => { unsubItems(); unsubChat(); };
            }, [listData]);

            const handleAddItem = async (newItem) => { if (!user) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_items`), { ...newItem, createdAt: serverTimestamp(), contributors: [], reservedBy: null, addedBy: mode === 'guest' ? guestName : 'Owner', addedByUid: user.uid }); } catch (e) { console.error("Add Item Error:", e); alert("Fehler beim Hinzufügen."); } };
            const handleUpdateItem = async (itemId, updatedFields) => { if (!user) return; try { const itemRef = doc(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_items`, itemId); await updateDoc(itemRef, updatedFields); } catch (e) { console.error("Update Item Error:", e); alert("Fehler beim Bearbeiten."); } };
            const handleDeleteItem = async (id) => { if (!user) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_items`, id)); } catch (e) { console.error("Delete Error:", e); } };
            const handleToggleReservation = async (item, type, amount = null) => {
                if (!user) return;
                if (!guestName || guestName.trim() === '') { alert("Bitte gib zuerst deinen Namen an (Login oder Gast-Zugang)."); return; }
                const itemRef = doc(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_items`, item.id);
                const userObj = { uid: user.uid, name: guestName, amount: amount || 0 };
                try {
                if (type === 'group' || (item.contributors && item.contributors.length > 0)) {
                    const hasJoined = item.contributors?.some(c => c.uid === user.uid);
                    let newContributors = item.contributors || [];
                    if (hasJoined) {
                        if (amount === 0) { newContributors = newContributors.filter(c => c.uid !== user.uid); } 
                        else if (amount > 0) { newContributors = newContributors.map(c => c.uid === user.uid ? { ...c, amount } : c); } 
                        else { newContributors = newContributors.filter(c => c.uid !== user.uid); }
                    } else { newContributors.push(userObj); triggerConfetti(); }
                    await updateDoc(itemRef, { contributors: newContributors, reservedBy: null });
                } else {
                    const isReservedByMe = item.reservedBy?.uid === user.uid;
                    if (item.reservedBy && !isReservedByMe) { alert("Bereits reserviert von " + item.reservedBy.name); return; }
                    const newReservedBy = isReservedByMe ? null : userObj;
                    if (!isReservedByMe) triggerConfetti();
                    await updateDoc(itemRef, { reservedBy: newReservedBy });
                }
                } catch (e) { console.error("Reservation Error:", e); alert("Konnte Reservierung nicht ändern. Bist du eingeloggt?"); }
            };
            const handleToggleBought = async (item) => { if (!user) return; try { const itemRef = doc(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_items`, item.id); if (!item.isBought) triggerConfetti(); await updateDoc(itemRef, { isBought: !item.isBought }); } catch(e) { console.error("Buying Error:", e); } };
            const handleSendMessage = async (text) => { if (!user) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `list_${listData.id}_chat`), { text, sender: guestName, uid: user.uid, createdAt: serverTimestamp() }); } catch (e) { console.error("Send Msg Error:", e); } };
            const getDaysLeft = () => { if (!listData?.eventDate) return null; const diff = new Date(listData.eventDate) - new Date(); return Math.ceil(diff / (1000 * 60 * 60 * 24)); };
            const daysLeft = getDaysLeft();
            const visibleItems = items.filter(item => { const secretCheck = mode === 'owner' ? !item.isSecret : true; const categoryCheck = activeCategory === 'all' ? true : item.category === activeCategory; return secretCheck && categoryCheck; });
            const totalItems = items.filter(i => !i.isSecret).length;
            const doneItems = items.filter(i => !i.isSecret && (i.isBought || (i.contributors && i.contributors.length > 0))).length;
            const progress = totalItems > 0 ? (doneItems / totalItems) * 100 : 0;
            const handleShare = () => { try { const url = `${window.location.origin}${window.location.pathname}?list=${listData.id}`; navigator.clipboard.writeText(url); alert("Link in Zwischenablage kopiert!"); } catch (e) { alert("ID zum Teilen: " + listData.id); } };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative flex flex-col">
                <div className={`${mode === 'owner' ? 'bg-indigo-600' : 'bg-emerald-600'} text-white p-6 pb-4 rounded-b-3xl shadow-lg relative z-10 transition-colors duration-500`}>
                    <div className="flex justify-between items-start mb-4">
                    <button onClick={onBack} className="opacity-80 hover:opacity-100 text-sm flex items-center gap-1">&larr; Zurück</button>
                    <div className="text-xs bg-white/20 px-2 py-1 rounded-full backdrop-blur-sm flex items-center gap-1 cursor-default select-none"><User size={10} /> {mode === 'owner' ? 'Ersteller-Modus' : `Gast: ${guestName}`}</div>
                    </div>
                    <div className="flex justify-between items-end mb-4">
                    <div><h1 className="text-2xl font-bold mb-1">{listData.title}</h1><p className="opacity-90 text-sm flex items-center gap-2">{listData.eventDate && new Date(listData.eventDate).toLocaleDateString('de-DE')}</p></div>
                    {daysLeft !== null && (<div className="bg-white/10 backdrop-blur-md rounded-lg p-2 text-center min-w-[70px]"><span className="block text-2xl font-bold leading-none">{daysLeft > 0 ? daysLeft : 0}</span><span className="text-[10px] uppercase tracking-wide opacity-80">Tage</span></div>)}
                    </div>
                    {mode === 'owner' && (<div className="flex flex-col gap-2 mt-4 animate-in fade-in slide-in-from-bottom-2"><div className="flex items-center justify-between bg-white/10 p-2 rounded-lg border border-indigo-400/30"><div className="flex flex-col"><span className="text-[10px] text-indigo-200 uppercase tracking-wider font-bold">Gruppen-Code</span><span className="text-lg font-mono font-bold tracking-widest text-white select-all">{listData.id}</span></div><button onClick={() => {navigator.clipboard.writeText(listData.id); alert("Code kopiert!");}} className="bg-white/20 hover:bg-white/30 text-white p-2 rounded-lg transition-colors" title="Code kopieren"><Copy size={16} /></button></div><button onClick={handleShare} className="w-full bg-white text-indigo-700 py-2 rounded-lg shadow-sm hover:bg-indigo-50 font-bold text-sm flex items-center justify-center gap-2 transition-colors"><LinkIcon size={14} /> Link teilen</button></div>)}
                    {mode === 'guest' && (<div className="mt-4"><div className="flex justify-between text-xs mb-1 opacity-90"><span>Geschenke-Fortschritt</span><span>{Math.round((items.filter(i => !i.isSecret).length > 0 ? (items.filter(i => !i.isSecret && (i.isBought || (i.contributors && i.contributors.length > 0))).length / items.filter(i => !i.isSecret).length) * 100 : 0))}%</span></div><div className="h-2 bg-emerald-900/30 rounded-full overflow-hidden"><div className="h-full bg-emerald-300 transition-all duration-1000 ease-out" style={{ width: `${(items.filter(i => !i.isSecret).length > 0 ? (items.filter(i => !i.isSecret && (i.isBought || (i.contributors && i.contributors.length > 0))).length / items.filter(i => !i.isSecret).length) * 100 : 0)}%` }}></div></div></div>)}
                </div>
                {(mode === 'owner' || (mode === 'guest' && activeTab === 'wishes')) && (<div className="overflow-x-auto whitespace-nowrap px-4 py-3 bg-slate-50 border-b border-slate-200 no-scrollbar sticky top-0 z-20"><div className="flex gap-2"><button onClick={() => setActiveCategory('all')} className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all ${activeCategory === 'all' ? 'bg-slate-800 text-white shadow-md' : 'bg-white text-slate-500 border border-slate-200'}`}>Alle</button>{CATEGORIES.map(cat => { const Icon = cat.icon; return (<button key={cat.id} onClick={() => setActiveCategory(cat.id)} className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all flex items-center gap-1.5 ${activeCategory === cat.id ? 'bg-slate-800 text-white shadow-md' : 'bg-white text-slate-500 border border-slate-200'}`}><Icon size={12} /> {cat.label}</button>); })}</div></div>)}
                {mode === 'guest' && (<div className="flex bg-slate-100 p-1 mx-4 mt-4 rounded-xl relative z-10 shadow-sm mb-4"><button onClick={() => setActiveTab('wishes')} className={`flex-1 py-2 text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-all ${activeTab === 'wishes' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Gift size={16} /> Wünsche</button><button onClick={() => setActiveTab('chat')} className={`flex-1 py-2 text-sm font-medium rounded-lg flex items-center justify-center gap-2 transition-all ${activeTab === 'chat' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><MessageCircle size={16} /> Lounge</button></div>)}
                <div className="flex-1 overflow-y-auto px-4 pb-20 custom-scrollbar">
                    {(mode === 'owner' || (mode === 'guest' && activeTab === 'wishes')) && (
                    <div className="space-y-4 pt-2">
                        {visibleItems.length === 0 && <div className="text-center py-12 text-slate-400"><Gift className="w-12 h-12 mx-auto mb-2 opacity-20" /><p>Keine Wünsche in dieser Kategorie.</p></div>}
                        {visibleItems.map(item => (<WishListItem key={item.id} item={item} currentMode={mode} currentUserUid={user?.uid} guestName={guestName} onDelete={handleDeleteItem} onEdit={(item) => setEditingItem(item)} onSelect={(item) => setSelectedItem(item)} onToggleReservation={handleToggleReservation} onToggleBought={handleToggleBought} onOpenContribution={(item) => setContributingItem(item)} />))}
                    </div>
                    )}
                    {mode === 'guest' && activeTab === 'chat' && <ChatArea messages={messages} guestName={guestName} onSend={handleSendMessage} currentUserUid={user?.uid} />}
                </div>
                {(mode === 'owner' || (mode === 'guest' && activeTab === 'wishes')) && <AddItemInput currentMode={mode} onAdd={handleAddItem} />}
                {editingItem && (<EditItemModal item={editingItem} onClose={() => setEditingItem(null)} onSave={handleUpdateItem} />)}
                {selectedItem && (<WishDetailModal item={selectedItem} currentMode={mode} currentUserUid={user?.uid} guestName={guestName} onClose={() => setSelectedItem(null)} onToggleReservation={handleToggleReservation} onToggleBought={handleToggleBought} onOpenContribution={(item) => { setSelectedItem(null); setContributingItem(item); }} />)}
                {contributingItem && (<ContributionModal item={contributingItem} currentUserUid={user?.uid} onClose={() => setContributingItem(null)} onConfirm={(item, amount) => handleToggleReservation(item, 'group', amount)} />)}
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null); 
            const [authInitialized, setAuthInitialized] = useState(false);
            const [activeListData, setActiveListData] = useState(null);
            const [guestName, setGuestName] = useState(() => { try { return localStorage.getItem('wishlist_guest_name') || '' } catch(e) { return '' } });
            const [userLists, setUserLists] = useState([]);
            const [joinedLists, setJoinedLists] = useState([]);

            useEffect(() => { try { localStorage.setItem('wishlist_guest_name', guestName); } catch(e) {} }, [guestName]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) { setUser(currentUser); } 
                    else { try { const anon = await signInAnonymously(auth); setUser(anon.user); } catch(e) { console.error("Anon Auth Failed", e); } }
                    setAuthInitialized(true);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!authInitialized) return; 
                const params = new URLSearchParams(window.location.search);
                const listIdFromUrl = params.get('list');
                if (listIdFromUrl && !activeListData) {
                    const loadList = async () => { try { const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lists', listIdFromUrl); const snap = await getDoc(docRef); if (snap.exists()) { setActiveListData({ id: snap.id, ...snap.data() }); } } catch (e) { console.error("URL Load Error:", e); } };
                    loadList();
                }
            }, [authInitialized]);

            useEffect(() => {
                if (!user) { setUserLists([]); setJoinedLists([]); return; }
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'lists');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Split lists
                    const myLists = allLists.filter(l => l.ownerId === user.uid).sort(sortByDateDesc);
                    // Filter joined lists: where guestUids contains my uid AND I am not the owner
                    const joined = allLists.filter(l => l.guestUids?.includes(user.uid) && l.ownerId !== user.uid).sort(sortByDateDesc);
                    
                    setUserLists(myLists);
                    setJoinedLists(joined);
                });
                return () => unsubscribe();
            }, [user]);

            const handleEmailLogin = (email, password) => signInWithEmailAndPassword(auth, email, password);
            const handleRegister = (email, password) => createUserWithEmailAndPassword(auth, email, password);
            const handleLogout = async () => { await signOut(auth); window.location.href = window.location.pathname; };

            const handleCreateList = async (title, date) => {
                if (!user) return;
                try {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'lists'), { title, eventDate: date, ownerId: user.uid, createdAt: serverTimestamp(), guestUids: [] });
                    const newList = { id: docRef.id, title, eventDate: date, ownerId: user.uid };
                    setActiveListData(newList); safeUpdateURL(docRef.id);
                } catch (e) { console.error("Create List Error:", e); alert("Fehler beim Erstellen der Liste."); }
            };

            const handleJoinList = async (listId, name) => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lists', listId);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) {
                        const listData = { id: snap.id, ...snap.data() };
                        setGuestName(name); 
                        
                        // NEW: Persist join if user is authenticated (even anonymous)
                        if (user) {
                            await updateDoc(docRef, { guestUids: arrayUnion(user.uid) });
                        }

                        setActiveListData(listData);
                        safeUpdateURL(snap.id);
                    } else { alert("Liste nicht gefunden. Code überprüfen."); }
                } catch (e) { console.error("Join Error:", e); alert("Fehler beim Beitreten."); }
            };

            const handleOpenList = (list) => { setActiveListData(list); safeUpdateURL(list.id); };
            const handleDeleteList = async (listId) => { if (!confirm("Möchtest du diese Liste wirklich löschen?")) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lists', listId)); if (activeListData?.id === listId) { setActiveListData(null); safeUpdateURL(''); } } catch (e) { console.error("Delete List Error:", e); alert("Fehler beim Löschen."); } };

            if (!authInitialized) return <div className="h-screen flex items-center justify-center text-slate-400">Lade WunschWelle...</div>;

            if (!activeListData) {
                return ( <LandingPage onCreate={handleCreateList} onJoin={handleJoinList} user={user} onLogin={handleEmailLogin} onRegister={handleRegister} onLogout={handleLogout} myLists={userLists} joinedLists={joinedLists} onOpenList={handleOpenList} onDeleteList={handleDeleteList} /> );
            }

            const isOwner = user && user.uid === activeListData.ownerId;
            if (isOwner) { return <WishListDashboard listData={activeListData} mode="owner" guestName="" user={user} onBack={() => { setActiveListData(null); safeUpdateURL(''); }} />; }
            if (guestName) { 
                // Ensure we register guest presence if returning via direct link with cached name
                if (user && !activeListData.guestUids?.includes(user.uid)) {
                     // Silent update to ensure list appears in "Joined Lists" next time
                     const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'lists', activeListData.id);
                     updateDoc(docRef, { guestUids: arrayUnion(user.uid) }).catch(console.error);
                }
                return <WishListDashboard listData={activeListData} mode="guest" guestName={guestName} user={user} onBack={() => { setActiveListData(null); safeUpdateURL(''); }} />; 
            }
            return <InviteScreen listData={activeListData} onJoin={handleJoinList} />;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>